# Deep-Genetic Project Information

Comprehensive documentation for the somatic variant calling pipeline using DeepSomatic.

---

## Table of Contents
- [Project Overview](#project-overview)
- [Input Files](#input-files)
- [Output Files](#output-files)
- [Pipeline Workflow](#pipeline-workflow)
- [File Formats](#file-formats)

---

## Project Overview

This project implements a somatic variant calling pipeline using Google's DeepSomatic deep learning model. The pipeline processes tumor DNA sequencing data to identify somatic variants (mutations present in tumor tissue but not in normal tissue).

**Key Features:**
- Tumor-only variant calling using DeepSomatic
- Comparison with NIST ground truth for validation
- Visualization of variant calling performance
- Automated metrics calculation (Precision, Recall, F1 Score)

---

## Input Files

All input files are located in the `deepsomatic_test/` directory.

### Tumor Sample Data

| File | Type | Description | Size |
|------|------|-------------|------|
| `NA12878_S1.chr20.10_10p1mb.bam` | BAM | Aligned tumor DNA reads (chromosome 20, region 10-10.1Mb) | ~3.9 MB |
| `NA12878_S1.chr20.10_10p1mb.bam.bai` | BAI | BAM index file for fast random access | ~5.5 KB |

**Details:**
- **Sample**: NA12878 (used as tumor sample in this test)
- **Region**: Chromosome 20, positions 10,000,000 to 10,100,000 (100kb region)
- **Reference Build**: hg19
- **Sequencing Type**: Whole Genome Sequencing (WGS)

### Reference Genome

| File | Type | Description | Size |
|------|------|-------------|------|
| `ucsc.hg19.chr20.unittest.fasta` | FASTA | Reference genome sequence (chromosome 20) | ~64 MB |
| `ucsc.hg19.chr20.unittest.fasta.fai` | FAI | FASTA index | 23 bytes |
| `ucsc.hg19.chr20.unittest.fasta.gz` | FASTA.GZ | Compressed reference genome | ~607 KB |
| `ucsc.hg19.chr20.unittest.fasta.gz.fai` | FAI | Compressed FASTA index | 23 bytes |
| `ucsc.hg19.chr20.unittest.fasta.gz.gzi` | GZI | BGZF index for compressed FASTA | ~15 KB |

**Details:**
- **Build**: hg19 (GRCh37)
- **Chromosome**: chr20 only
- **Purpose**: Reference for variant calling and alignment validation

### Ground Truth / Validation Data

| File | Type | Description | Size |
|------|------|-------------|------|
| `test_nist.b37_chr20_100kbp_at_10mb.vcf.gz` | VCF.GZ | NIST truth set variants | ~5.7 KB |
| `test_nist.b37_chr20_100kbp_at_10mb.vcf.gz.tbi` | TBI | VCF index (Tabix) | 197 bytes |
| `test_nist.b37_chr20_100kbp_at_10mb.bam.bai` | BAI | BAM index for validation | 236 bytes |

**Details:**
- **Source**: NIST Genome in a Bottle (GIAB)
- **Reference Build**: b37 (similar to hg19, but different chromosome naming)
- **Region**: Chromosome 20, 100kb region at 10Mb position
- **Purpose**: Ground truth for benchmarking variant calling accuracy

> **Note**: The ground truth uses b37 reference (chromosome names like "20") while the input BAM uses hg19 (chromosome names like "chr20"). The comparison tools handle this difference automatically.

---

## Output Files

All output files are generated in the `deepsomatic_output/` directory.

### Primary Outputs

| File | Type | Description |
|------|------|-------------|
| `output.vcf.gz` | VCF.GZ | Compressed VCF with called somatic variants |
| `output.vcf.gz.tbi` | TBI | Tabix index for the VCF file |
| `output.g.vcf.gz` | GVCF.GZ | Genomic VCF with all positions (including non-variant sites) |
| `output.g.vcf.gz.tbi` | TBI | Tabix index for the GVCF file |

**VCF vs GVCF:**
- **VCF**: Contains only positions with called variants
- **GVCF**: Contains all positions, including reference calls (useful for downstream analysis)

### Comparison Results

Generated by `compare_vcf.py`:

| File | Type | Description |
|------|------|-------------|
| `comparison_results.csv` | CSV | Detailed variant-by-variant comparison (TP/FP/FN classification) |
| `comparison_report.png` | PNG | Visualization of metrics and variant counts |

**CSV Columns:**
- `Category`: True Positive, False Positive, or False Negative
- `Chromosome`: Chromosome number
- `Position`: Genomic position
- `Reference`: Reference allele
- `Alternate`: Alternate allele

### Intermediate Files

| Directory/File | Description |
|----------------|-------------|
| `logs/` | DeepSomatic execution logs |
| `intermediate/` | Intermediate processing files (examples, call variants data) |

---

## Pipeline Workflow

### Step 1: Run DeepSomatic Variant Calling

```bash
python3 run_deepsomatic.py [--verbose]
```

**What happens:**
1. **Setup**: Creates output directory, validates input files
2. **Docker Execution**: Runs DeepSomatic in a Docker container
   - Mounts project directory as `/data` inside container
   - Uses `google/deepsomatic:1.8.0` image
3. **Processing Steps** (inside DeepSomatic):
   - `make_examples_somatic`: Extracts candidate variants from BAM
   - `call_variants`: Deep learning model classifies variants
   - `postprocess_variants`: Generates final VCF/GVCF files
4. **Output**: Generates `output.vcf.gz` and `output.g.vcf.gz`

**Configuration:**
- Model Type: WGS (Whole Genome Sequencing)
- Sample Name: tumor_sample
- Number of Shards: 1 (for parallel processing)

**Optional Flags:**
- `--verbose`: Enable detailed output and automatic visualization

---

### Step 2: Compare with Ground Truth

```bash
python3 compare_vcf.py \
  --truth deepsomatic_test/test_nist.b37_chr20_100kbp_at_10mb.vcf.gz \
  --query deepsomatic_output/output.vcf.gz \
  [--output-dir deepsomatic_output]
```

**What happens:**
1. **Load VCF Files**: Parse both ground truth and query VCF files
2. **Normalize**: Handle chromosome naming differences (b37 vs hg19)
3. **Compare Variants**: Classify each variant as:
   - **True Positive (TP)**: Variant in both truth and query
   - **False Positive (FP)**: Variant in query but not in truth
   - **False Negative (FN)**: Variant in truth but missed in query
4. **Calculate Metrics**:
   - **Precision** = TP / (TP + FP) - How many called variants are correct?
   - **Recall** = TP / (TP + FN) - How many true variants were found?
   - **F1 Score** = 2 × (Precision × Recall) / (Precision + Recall) - Harmonic mean
5. **Generate Outputs**:
   - Console summary with metrics
   - `comparison_results.csv` with detailed results
   - `comparison_report.png` with visualizations

---

### Step 3: Visualize Results (Optional)

```bash
python3 visualize_variants.py
```

**What happens:**
1. **Load Variants**: Extract variants from both VCF files using pysam
2. **Filter**: Keep only PASS variants
3. **Calculate Overlap**: Compute TP, FP, FN sets
4. **Display Metrics**: Print precision, recall, F1 score
5. **Generate Venn Diagram**: Visual representation of variant overlap

---

## File Formats

### BAM (Binary Alignment Map)

Binary format storing aligned DNA sequencing reads.

**Key Fields:**
- Read sequence and quality scores
- Alignment position and CIGAR string
- Mapping quality
- Read flags (paired, properly paired, etc.)

**Index (.bai)**: Enables fast random access to specific genomic regions

---

### FASTA (Reference Genome)

Text format storing reference genome sequences.

**Format:**
```
>chr20
NNNNNNNNNNATCGATCGATCG...
```

**Index (.fai)**: Contains chromosome names, lengths, and byte offsets

---

### VCF (Variant Call Format)

Text format for storing genetic variants.

**Header Lines** (start with `#`):
- Metadata about reference, contigs, INFO fields, FORMAT fields

**Data Lines** (tab-separated):
```
CHROM  POS     ID  REF  ALT  QUAL  FILTER  INFO  FORMAT  SAMPLE
chr20  100001  .   A    G    30    PASS    ...   GT:DP   0/1:25
```

**Key Columns:**
- `CHROM`: Chromosome
- `POS`: Position (1-based)
- `REF`: Reference allele
- `ALT`: Alternate allele(s)
- `QUAL`: Quality score
- `FILTER`: PASS or filter reasons
- `INFO`: Variant annotations
- `FORMAT`: Sample field formats
- `SAMPLE`: Sample-specific data

**Compression:**
- `.vcf.gz`: BGZF-compressed VCF
- `.tbi`: Tabix index for fast random access

---

### GVCF (Genomic VCF)

Extended VCF format that includes reference calls (non-variant positions).

**Purpose:**
- Distinguish between "no variant called" vs "no coverage"
- Enable joint calling across multiple samples
- Provide confidence scores for reference calls

**Special Features:**
- Contains blocks of reference positions
- Uses `<NON_REF>` symbolic allele
- Includes genotype likelihoods for all positions

---

## Pipeline Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                     INPUT FILES                             │
├─────────────────────────────────────────────────────────────┤
│  • Tumor BAM (NA12878_S1.chr20.10_10p1mb.bam)              │
│  • Reference Genome (ucsc.hg19.chr20.unittest.fasta)       │
│  • Ground Truth VCF (test_nist.b37_chr20_100kbp_at_10mb)   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              STEP 1: DeepSomatic (Docker)                   │
├─────────────────────────────────────────────────────────────┤
│  1. make_examples_somatic  → Extract candidate variants     │
│  2. call_variants          → Deep learning classification   │
│  3. postprocess_variants   → Generate VCF/GVCF             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   PRIMARY OUTPUTS                           │
├─────────────────────────────────────────────────────────────┤
│  • output.vcf.gz    (Variant calls)                        │
│  • output.g.vcf.gz  (Genomic VCF)                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│         STEP 2: Comparison with Ground Truth               │
├─────────────────────────────────────────────────────────────┤
│  1. Load and parse VCF files                               │
│  2. Normalize chromosome names                             │
│  3. Compare variants (TP/FP/FN)                            │
│  4. Calculate metrics (Precision/Recall/F1)                │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│               VALIDATION OUTPUTS                            │
├─────────────────────────────────────────────────────────────┤
│  • comparison_results.csv   (Detailed results)             │
│  • comparison_report.png    (Metrics visualization)        │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│         STEP 3: Visualization (Optional)                    │
├─────────────────────────────────────────────────────────────┤
│  • Venn diagram showing variant overlap                    │
│  • Performance metrics display                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Dependencies

See `requirements.txt` for Python package dependencies:
- `matplotlib>=3.5.0` - Plotting and visualizations
- `seaborn>=0.12.0` - Statistical visualizations
- `numpy>=1.21.0` - Numerical operations
- `pysam>=0.22.0` - VCF/BAM file parsing
- `matplotlib-venn>=0.11.0` - Venn diagram visualization

**External Dependencies:**
- Docker (for running DeepSomatic container)
- `google/deepsomatic:1.8.0` Docker image

---

## Performance Metrics Explained

### Precision
**Formula**: TP / (TP + FP)

**Meaning**: Of all the variants we called, what percentage are actually real?
- High precision = Few false positives
- Low precision = Many false alarms

### Recall (Sensitivity)
**Formula**: TP / (TP + FN)

**Meaning**: Of all the real variants, what percentage did we find?
- High recall = Few missed variants
- Low recall = Many variants missed

### F1 Score
**Formula**: 2 × (Precision × Recall) / (Precision + Recall)

**Meaning**: Harmonic mean of precision and recall
- Balances both metrics
- Useful when you care equally about precision and recall
- Range: 0.0 (worst) to 1.0 (perfect)

---

## Troubleshooting

### Common Issues

**Docker not found:**
```bash
# Install Docker
sudo apt-get install docker.io  # Ubuntu/Debian
```

**Permission denied for Docker:**
```bash
# Add user to docker group
sudo usermod -aG docker $USER
# Log out and back in
```

**Missing Python dependencies:**
```bash
pip install -r requirements.txt
```

**Chromosome naming mismatch:**
- The comparison tool automatically handles b37 vs hg19 differences
- If issues persist, check that VCF files are properly formatted

---

## References

- **DeepSomatic**: [Google DeepVariant/DeepSomatic](https://github.com/google/deepvariant)
- **NIST GIAB**: [Genome in a Bottle](https://www.nist.gov/programs-projects/genome-bottle)
- **VCF Specification**: [VCF v4.2](https://samtools.github.io/hts-specs/VCFv4.2.pdf)
- **BAM Format**: [SAM/BAM Specification](https://samtools.github.io/hts-specs/SAMv1.pdf)
